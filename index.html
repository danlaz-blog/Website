<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dan Laz ‚Äî Y2K Arcade (Games, GIFs, Vibes)</title>
<style>
:root{
  --bg:#0b0c1a; --panel:rgba(17,17,51,0.86); --ink:#e7f7ff;
  --neon1:#00FF66; --neon2:#FF00FF; --neon3:#00FFFF; --accent:#FFD76A;
}
body.theme-dark { --bg:#0b0c1a; --panel:rgba(17,17,51,0.86) }
body.theme-vapor{ --bg:#241b2b; --panel:rgba(36,27,43,0.86); --neon1:#ff8fd9; --neon2:#8efff4; --neon3:#ffd66f; --accent:#b28dff }
body.theme-ocean{ --bg:#08223a; --panel:rgba(8,34,58,0.86); --neon1:#4affc6; --neon2:#3fd0ff; --neon3:#8ef9ff; --accent:#ffd66f }

html,body{height:100%}
body{
  margin:0; color:var(--ink);
  font-family:"Trebuchet MS","Verdana","Comic Sans MS",system-ui,sans-serif;
  background: radial-gradient(1200px 500px at 50% -20%, rgba(255,255,255,0.05), transparent 60%),
              radial-gradient(800px 400px at 80% 120%, rgba(255,255,255,0.05), transparent 60%), #000;
  background-color:var(--bg);
}
body::before{
  content:""; position:fixed; inset:0;
  background-image:
    radial-gradient(1px 1px at 20% 30%, #fff5, transparent 60%),
    radial-gradient(1px 1px at 70% 10%, #fff6, transparent 60%),
    radial-gradient(1px 1px at 40% 70%, #fff4, transparent 60%),
    radial-gradient(1px 1px at 85% 55%, #fff7, transparent 60%);
  background-repeat:repeat; background-size:300px 300px; pointer-events:none;
}
.container{
  max-width:980px; margin:20px auto; background:var(--panel);
  border:2px solid var(--neon3); box-shadow:0 0 14px var(--neon3), inset 0 0 18px var(--neon2);
}
.header{ padding:8px 12px; border-bottom:2px dashed var(--neon2); background:linear-gradient(180deg, rgba(255,255,255,0.08), transparent) }
.h1{ margin:6px 0 0; font-size:28px; letter-spacing:1px; text-transform:uppercase; text-shadow:0 0 5px var(--neon3),0 0 14px var(--neon2),1px 1px 0 #fff2 }
.subtitle{font-size:12px; opacity:.85}

.marquee { white-space:nowrap; overflow:hidden; border-top:1px dotted var(--neon1); border-bottom:1px dotted var(--neon1) }
.marquee span{ display:inline-block; padding-left:100%; animation:scroll 14s linear infinite }
@keyframes scroll { to{ transform: translateX(-100%) } }

.layout{ width:100%; border-collapse:collapse }
.leftcol{ width:210px; vertical-align:top }
.rightcol{ vertical-align:top }
nav{ background:rgba(0,0,0,0.25); padding:10px; border-right:2px dotted var(--neon1) }
nav a{ display:block; color:var(--ink); text-decoration:none; padding:6px 8px; margin:5px 0; border:1px solid var(--neon2); background:rgba(0,0,0,0.25); box-shadow: inset 0 0 8px var(--neon2) }
nav a:hover{ background:rgba(255,0,255,0.15); text-decoration:underline }
.main{ padding:16px }
.card{ margin:12px 0; padding:12px; border:1px solid var(--neon1); background:rgba(0,0,0,0.35) }

.divider{ height:22px; margin:8px 0; position:relative; overflow:hidden; border-top:1px solid var(--neon3); border-bottom:1px solid var(--neon3) }
.divider::before{ content:""; position:absolute; inset:0; background:repeating-linear-gradient(90deg, var(--neon2) 0 6px, transparent 6px 12px); opacity:.28; animation:slideX 3s linear infinite }
@keyframes slideX{ from{transform:translateX(0)} to{transform:translateX(-12px)} }

.uc{ height:28px; border:1px solid var(--accent); background:repeating-linear-gradient(-45deg, #000 0 14px, var(--accent) 14px 28px); position:relative; color:#000; display:flex; align-items:center; justify-content:center; font-weight:bold; letter-spacing:1px }
.uc span{ background:#000c; color:var(--ink); padding:2px 6px; border:1px solid var(--neon3) }
@keyframes blinker{ 50%{opacity:0} } .blink{ animation:blinker 1s steps(1,end) infinite }
.badges{ display:flex; flex-wrap:wrap; gap:6px }
.badge{ width:88px; height:31px; position:relative; border:1px solid var(--neon3); background:#111133; display:inline-flex; align-items:center; justify-content:center; font-size:10px; text-transform:uppercase; box-shadow: inset 0 0 10px var(--neon2) }
.badge::after{ content:""; position:absolute; inset:2px; border:1px solid var(--neon2) }

ul.star{ list-style:'‚ú¶  '; padding-left:1.1em }
.footer{ padding:8px; text-align:center; border-top:2px dashed var(--neon2); font-size:12px }
@media (max-width:720px){ .layout, .leftcol, .rightcol, nav { display:block; width:auto !important } nav{ border-right:none; border-bottom:2px dotted var(--neon1) } }
.crt{ position:fixed; inset:0; pointer-events:none; mix-blend-mode:screen; background:linear-gradient(transparent 96%, #0005 100%) 0 0/100% 2px, radial-gradient(circle at 50% 50%, #fff1, transparent 60%); opacity:.28; animation:crtFlicker 2.5s infinite ease-in-out alternate }
@keyframes crtFlicker{ 0%{opacity:.22} 100%{opacity:.32} }
#fx{ position:fixed; left:0; top:0; width:100vw; height:100vh; pointer-events:none }
#screensaver{ position:fixed; inset:0; background:#000; display:none; z-index:99999; cursor:none }
#dvd{ position:absolute; width:200px; height:100px; display:flex; align-items:center; justify-content:center; color:#000; font-weight:bold; letter-spacing:2px; background:linear-gradient(135deg, var(--neon3), var(--neon2)); border:3px solid #fff; box-shadow:0 0 20px var(--neon3), inset 0 0 10px #fff8 }
.btns button{ margin:3px; padding:6px 8px; border:1px solid var(--neon3); background:#000; color:var(--ink); cursor:pointer }
.btns button:hover{ background:#001a1a }
.mono{ font-family:"Courier New", monospace; font-size:12px } .small{ font-size:12px; opacity:.9 } .center{ text-align:center }
.gifgrid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:12px }
.gifcell{ background:#0003; border:1px solid var(--neon1); padding:8px; text-align:center }
.gifcell img{ max-width:100%; height:auto; border:1px solid var(--neon3); box-shadow:0 0 8px var(--neon2) }

/* Intro overlay (contenuto: tagline) */
#psxIntro{ position:fixed; inset:0; background:#000; display:flex; align-items:center; justify-content:center; z-index:100000; color:#fff; flex-direction:column; text-align:center; padding:0 16px; }
#psxPress{ margin-top:20px; font-size:12px; opacity:.8 }

/* ==== Arcade font override (solo font di sistema, sicuro) ==== */
body{ font-family:"Impact","Trebuchet MS","Verdana",system-ui,sans-serif; }
.h1{ font-family:"Arial Black","Impact","Trebuchet MS","Verdana",system-ui,sans-serif; letter-spacing:1.4px; }
nav a, .btns button, h2{ font-family:"Impact","Trebuchet MS","Verdana",system-ui,sans-serif; letter-spacing:0.8px; text-transform:uppercase; }
.mono{ font-family:"Lucida Console","Courier New",monospace; font-size:12px; }

/* ==== Overlay sfondo aurora/arcobaleno (delicato) ==== */
#bgRainbow{
  position:fixed; inset:0; pointer-events:none;
  mix-blend-mode:screen;
  opacity:.30;
  background:
    radial-gradient(1000px 600px at 20% 20%, #ff66ff22, transparent 60%),
    radial-gradient(900px 500px at 80% 30%, #66ffff22, transparent 60%),
    radial-gradient(1100px 700px at 50% 80%, #00ff6622, transparent 60%),
    conic-gradient(from 0deg at 50% 50%, #ff004480, #ff7a0080, #ffee0080, #33ff6680, #33ccff80, #7a66ff80, #ff00ff80, #ff004480);
  animation: bgSpin 120s linear infinite;
}
@keyframes bgSpin{ to{ transform:rotate(360deg) } }
@media (prefers-reduced-motion: reduce){ #bgRainbow{ animation:none } }

/* ==== Big Tagline Intro (replace PS1 logo) ==== */
.introTagline{
  text-align:center;
  max-width: min(1000px, 85vw);
  filter: drop-shadow(0 0 10px #fff4) drop-shadow(0 0 24px var(--neon3));
  animation: psxGlow 1.8s ease-out forwards;
}
.introTagline .t1{
  display:block;
  font-family:"Arial Black","Impact",system-ui,sans-serif;
  font-size: clamp(26px, 6vw, 56px);
  line-height:1.05;
  letter-spacing:1.2px;
  background: linear-gradient(90deg, var(--neon3), var(--neon2), var(--neon1));
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  text-shadow: 0 0 12px #00ffff33, 0 0 24px #ff00ff22;
}
.introTagline .t2{
  display:block;
  margin-top: 10px;
  font-family:"Impact","Trebuchet MS",system-ui,sans-serif;
  font-size: clamp(18px, 3vw, 28px);
  letter-spacing:1px;
  color: var(--accent);
}

/* (facoltativo) effetto typing per .t1: attiva aggiungendo .typing a .introTagline */
.introTagline.typing .t1{
  white-space: nowrap;
  overflow: hidden;
  border-right: 2px solid var(--neon3);
  animation: typeWrite 2.6s steps(40,end) 0.2s 1 both, caret 0.8s steps(1,end) infinite;
}
@keyframes typeWrite { from { width: 0 } to { width: 100% } }
@keyframes caret { 50% { border-color: transparent } }

/* Keyframes riusati */
@keyframes psxGlow{ 0%{opacity:0; transform:scale(0.8)} 40%{opacity:1} 100%{opacity:1; transform:scale(1)} }
@keyframes psxScan{ 0%{opacity:.0; transform:translateY(-40%)} 45%{opacity:.8} 100%{opacity:0; transform:translateY(40%)} }
</style>
</head>
<body class="theme-dark">

<!-- Intro overlay: big tagline (no SVG logo) -->
<div id="psxIntro" aria-label="Intro">
  <div class="introTagline">
    <span class="t1">Welcome to the greatest website on Earth</span>
    <span class="t2">‚Äî Dan Laz</span>
  </div>
  <div id="psxPress" class="mono">Click to start</div>
</div>

<canvas id="fx"></canvas>

<!-- Overlay sfondo delicato -->
<div id="bgRainbow" aria-hidden="true"></div>

<!-- Screensaver canvas container -->
<div id="screensaver"><div id="dvd">Dan Laz</div></div>

<div class="crt" id="crtLayer"></div>

<div class="container">
  <div class="header">
    <div class="h1">Dan Laz <span class="blink">[BETA]</span></div>
    <div class="subtitle mono">Welcome to the greatest website on Earth ‚Äî Dan Laz ‚Ä¢ Best viewed in 800√ó600</div>
  </div>

  <marquee behavior="scroll" direction="left" scrollamount="5" class="mono">
    ‚ú® Welcome to the greatest website on Earth ‚Äî Dan Laz. Retro games, neon borders, dusty cartridges & happy glitches. ‚ú®
  </marquee>

  <table class="layout">
    <tr>
      <td class="leftcol">
        <nav>
          #homeüè† Home</a>
          #newsüì∞ News</a>
          #gifparadeüéûÔ∏è GIF Parade</a>
          #galleryüñºÔ∏è Gallery</a>
          #cheatsüß™ Cheats</a>
          #guestbooküìñ Guestbook</a>
          #linksüîó Links</a>
          #aboutüë§ About</a>
          <div class="divider"></div>
          <div class="small mono">
            Visits: <span id="visitCounter">0</span><br/>
            Theme: <span id="themeName">dark</span><br/>
            Konami: try it! ‚Üë ‚Üë ‚Üì ‚Üì ‚Üê ‚Üí ‚Üê ‚Üí B A
          </div>
        </nav>
      </td>
      <td class="rightcol">
        <div class="main">

          <section id="home" class="card">
            <div class="uc"><span>UNDER CONSTRUCTION</span></div>
            <h2>Welcome</h2>
            <p>This is <strong>Dan Laz</strong>‚Äôs retro corner‚Äîneon lights, chunky buttons, whispered myths. Only Y2K vibes and endless ‚ÄúPress Start‚Äù.</p>
            <div class="badges">
              <div class="badge">Cool Site!</div>
              <div class="badge">88√ó31</div>
              <div class="badge">Y2K OK</div>
              <div class="badge">CRT Love</div>
              <div class="badge">Insert Coin</div>
            </div>
          </section>

          <div class="divider"></div>

          <section id="news" class="card">
            <h2>News (beautifully vague)</h2>
            <ul class="star">
              <li>Brushing off controllers, trying secret button combos nobody remembers.</li>
              <li>A cabinet somewhere expects a real coin and a bigger smile.</li>
              <li>If you hear a soft hum, that‚Äôs your heart‚Äôs transformer at 50‚ÄØHz.</li>
            </ul>
          </section>

          <!-- Local GIFs: update with your filenames under /assets/gifs -->
          <section id="gifparade" class="card">
            <h2>Retro GIF Parade ‚Äî Donkey Kong ‚Ä¢ Spyro ‚Ä¢ Zelda</h2>
            <p class="small">Upload your GIFs to <code>/assets/gifs/</code> and set the filenames below.</p>

            <h3>üçå Donkey Kong</h3>
            <div class="gifgrid">
              <div class="gifcell">/assets/gifs/dk.gif</div>
              <div class="gifcell">/assets/gifs/dk_dance.gif</div>
              <div class="gifcell">/assets/gifs/dk_pose.gif</div>
            </div>

            <h3>üêâ Spyro the Dragon</h3>
            <div class="gifgrid">
              <div class="gifcell">/assets/gifs/spyro.gif</div>
              <div class="gifcell">/assets/gifs/spyro_wave.gif</div>
              <div class="gifcell">/assets/gifs/spyro_sunglasses.gif</div>
            </div>

            <h3>üó°Ô∏è The Legend of Zelda</h3>
            <div class="gifgrid">
              <div class="gifcell">/assets/gifs/zelda_link.gif</div>
              <div class="gifcell">/assets/gifs/zelda_botw.gif</div>
              <div class="gifcell">/assets/gifs/zelda_fun.gif</div>
            </div>
          </section>

          <section id="gallery" class="card">
            <h2>Gallery (gif‚Äëlike illusions)</h2>
            <p class="small">Lightweight: CSS illusions instead of heavy files.</p>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;">
              <div class="badge" style="height:80px; font-size:12px; background:#111133;"><span style="animation:blinker 1s steps(1,end) infinite;">‚òÖ</span>&nbsp; Title Screen</div>
              <div class="badge" style="height:80px; background:#001a1a; box-shadow: inset 0 0 12px var(--neon3);">Loading...</div>
              <div class="badge" style="height:80px; background:#130f2b; position:relative;">
                <span style="position:absolute;left:8px;top:8px;">Stage 1</span>
                <span style="position:absolute;right:8px;bottom:8px; animation:slideX 2.2s linear infinite;">‚Üí</span>
              </div>
              <div class="badge" style="height:80px; background:#001; position:relative; overflow:hidden;">
                <span style="position:absolute;left:-10%;width:120%;top:0;bottom:0;background:linear-gradient(90deg,transparent, #fff3, transparent);animation:scan 2.8s linear infinite;"></span>
              </div>
            </div>
          </section>
          <style>@keyframes scan{from{transform:translateX(-100%)}to{transform:translateX(100%)}}</style>

          <section id="cheats" class="card">
            <h2>Cheats</h2>
            <p>No promises. Sometimes they work. Sometimes the universe laughs.</p>
            <div class="mono" id="cheatBox" style="padding:8px;border:1px dashed var(--neon2);">???</div>
            <div class="btns">
              <button onclick="randomCheat()">Generate Cheat</button>
              <button onclick="beep()">Beep!</button>
              <button onclick="playModem()">Modem Sound</button>
            </div>
          </section>

          <section id="guestbook" class="card">
            <h2>Guestbook</h2>
            <p class="small">Sign the book ‚Äî stored locally in your browser.</p>
            <form id="gbForm" class="mono" style="display:grid;grid-template-columns:1fr;gap:8px;max-width:460px">
              <input type="text" name="name" placeholder="Name (optional)" style="padding:6px;border:1px solid var(--neon3);background:#000;color:var(--ink)">
              <textarea name="msg" placeholder="Message" rows="3" style="padding:6px;border:1px solid var(--neon3);background:#000;color:var(--ink)"></textarea>
              <div>
                <button type="submit">Submit</button>
                <button type="button" onclick="clearGb()">Clear</button>
              </div>
            </form>
            <ul id="gbList" class="star"></ul>
          </section>

          <section id="links" class="card">
            <h2>Links</h2>
            <ul class="star">
              <li>If you were searching for something exact, it might be in another era.</li>
              <li>If you wanted to get lost: congratulations, you‚Äôre here.</li>
              <li>Have a personal page‚Äîimaginary or real? Drop it in the guestbook.</li>
            </ul>
          </section>

          <section id="about" class="card">
            <h2>About</h2>
            <p>Just someone who loves retro games and bright memories. I put <em>my whole self</em> here and leave room for the rest.</p>
            <div class="btns">
              <strong>Theme</strong>:
              <button onclick="setTheme('dark')">Dark</button>
              <button onclick="setTheme('vapor')">Vapor</button>
              <button onclick="setTheme('ocean')">Ocean</button>
              <strong>&nbsp;CRT</strong>:
              <button onclick="toggleCRT(true)">ON</button>
              <button onclick="toggleCRT(false)">OFF</button>
              <strong>&nbsp;FX</strong>:
              <button onclick="toggleSaver(true)">Screensaver</button>
              <button onclick="toggleSaver(false)">Stop</button>
              <strong>&nbsp;Screensaver/Giochi</strong>:
              <button onclick="startStarsSaver()">Star Voyage ‚ú®</button>
              <button onclick="startHauntedSaver()">Haunted House üëª</button>
              <button onclick="startMazeGame()">Maze Runner üïπÔ∏è</button>
              <button onclick="stopCustomSaver()">Stop</button>
            </div>
          </section>

          <div class="divider"></div>

        </div>
      </td>
    </tr>
  </table>

  <div class="footer mono">
    ¬© Dan Laz ‚Ä¢ <span class="blink">Under Construction</span> ‚Ä¢
    <span>Visits: <span id="visitCounter2">0</span></span> ‚Ä¢
    <span>Theme: <span id="themeName2">dark</span></span>
  </div>
</div>

<script>
const LS = { visits:'retro_visits', gb:'retro_guestbook', theme:'retro_theme', crt:'retro_crt' };

let audioCtx;
function startPsxIntroAudio(){
  try{
    audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
    const o1 = audioCtx.createOscillator(), g1 = audioCtx.createGain();
    o1.type='sawtooth'; o1.frequency.value=220; g1.gain.value=0.0001;
    o1.connect(g1).connect(audioCtx.destination);
    const now=audioCtx.currentTime;
    o1.frequency.linearRampToValueAtTime(440, now+1.2);
    g1.gain.exponentialRampToValueAtTime(0.08, now+0.2);
    g1.gain.exponentialRampToValueAtTime(0.0001, now+2.2);
    o1.start(now); o1.stop(now+2.3);
  }catch(e){}
}
(function(){
  const overlay = document.getElementById('psxIntro');
  function start(){
    startPsxIntroAudio();
    overlay.style.transition='opacity .6s ease';
    overlay.style.opacity='0';
    setTimeout(()=> overlay.style.display='none', 600);
  }
  overlay.addEventListener('click', start);
})();

/* Visit counter */
(function(){
  let c = +(localStorage.getItem(LS.visits)||0) + 1;
  localStorage.setItem(LS.visits, c);
  (document.getElementById('visitCounter')||{}).textContent = c;
  (document.getElementById('visitCounter2')||{}).textContent = c;
})();

/* Theme */
function applyTheme(t){
  document.body.classList.remove('theme-dark','theme-vapor','theme-ocean');
  document.body.classList.add('theme-'+t);
  localStorage.setItem(LS.theme, t);
  (document.getElementById('themeName')||{}).textContent = t;
  (document.getElementById('themeName2')||{}).textContent = t;
}
function setTheme(t){ applyTheme(t) }
applyTheme(localStorage.getItem(LS.theme)||'dark');

/* CRT toggle */
function toggleCRT(on){
  const crt = document.getElementById('crtLayer');
  crt.style.display = on ? 'block' : 'none';
  localStorage.setItem(LS.crt, on ? '1':'0');
}
toggleCRT(localStorage.getItem(LS.crt)==='0' ? false : true);

/* Star trail (mouse FX) */
(function(){
  const canvas = document.getElementById('fx');
  const ctx = canvas.getContext('2d');
  let W=canvas.width=innerWidth, H=canvas.height=innerHeight;
  let parts=[];
  function add(x,y){
    parts.push({ x,y, vx:(Math.random()*2-1)*0.8, vy:(Math.random()*2-1)*0.8,
      life:1, color:['#00FFFF','#FF00FF','#00FF66','#FFD76A'][Math.floor(Math.random()*4)] });
  }
  function loop(){
    ctx.clearRect(0,0,W,H);
    parts.forEach(p=>{
      p.x+=p.vx; p.y+=p.vy; p.life-=0.02;
      ctx.globalAlpha = Math.max(0,p.life);
      ctx.fillStyle = p.color;
      ctx.beginPath(); ctx.arc(p.x,p.y,3,0,Math.PI*2); ctx.fill();
    });
    parts = parts.filter(p=>p.life>0);
    requestAnimationFrame(loop);
  }
  loop();
  addEventListener('mousemove', e=> add(e.clientX,e.clientY));
  addEventListener('resize', ()=>{ W=canvas.width=innerWidth; H=canvas.height=innerHeight; });
})();

/* Guestbook */
function renderGB(){
  let list = [];
  try{ list = JSON.parse(localStorage.getItem(LS.gb)||'[]'); }catch(e){}
  const ul = document.getElementById('gbList'); if(!ul) return;
  ul.innerHTML = '';
  list.forEach(it=>{
    const li=document.createElement('li');
    li.innerHTML = `<strong>${escapeHtml(it.name||'Anonymous')}</strong>: ${escapeHtml(it.msg||'')}`;
    ul.appendChild(li);
  });
}
function clearGb(){ localStorage.removeItem(LS.gb); renderGB(); }
(function(){
  renderGB();
  const form = document.getElementById('gbForm');
  if(form){
    form.addEventListener('submit', ev=>{
      ev.preventDefault();
      const name = form.name.value.trim() || 'Anonymous';
      const msg  = form.msg.value.trim();
      if(!msg) return;
      let list=[]; try{ list = JSON.parse(localStorage.getItem(LS.gb)||'[]'); }catch(e){}
      list.unshift({name, msg});
      localStorage.setItem(LS.gb, JSON.stringify(list));
      form.reset(); renderGB();
      beep();
    });
  }
})();
function escapeHtml(s){return s.replace(/[&<>\"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]))}

/* Cheats */
const CHEATS = [
  "SELECT‚ÄîUP‚ÄîUP‚ÄîB‚ÄîA‚ÄîSTART (maybe).",
  "Hold START for 10 seconds on the title‚Ä¶ then listen.",
  "Left, Left, Right, Up, Down ‚Äî then wait.",
  "Pause three times. Do not ask why.",
  "Press A when the cursor blinks (when it really blinks).",
  "Enter your name as ‚ÄòAAA‚Äô and pretend nothing happened.",
  "Jump when it‚Äôs pointless. Sometimes it‚Äôs not."
];
function randomCheat(){ document.getElementById('cheatBox').textContent = CHEATS[Math.floor(Math.random()*CHEATS.length)] }

/* Sounds */
function ac(){ return audioCtx || (audioCtx = new (window.AudioContext||window.webkitAudioContext)()) }
function beep(){
  const ctx = ac();
  const o = ctx.createOscillator(), g = ctx.createGain();
  o.type='square'; o.frequency.value=880; g.gain.value=0.05;
  o.connect(g).connect(ctx.destination); o.start(); setTimeout(()=>o.stop(),140);
}
function playModem(){
  const ctx = ac();
  const seq = [900,1200,700,1400,400,1800,600,1500,1000,300];
  let t = ctx.currentTime;
  seq.forEach((f,i)=>{
    const o = ctx.createOscillator(), g = ctx.createGain();
    o.type = i%2 ? 'sawtooth' : 'square';
    o.frequency.setValueAtTime(f, t);
    g.gain.setValueAtTime(0.04, t);
    o.connect(g).connect(ctx.destination);
    o.start(t); o.stop(t+0.08);
    t += 0.085;
  });
}

/* Konami */
(function(){
  const KONAMI = [38,38,40,40,37,39,37,39,66,65];
  let pos = 0;
  addEventListener('keydown', e=>{
    if(e.keyCode === KONAMI[pos]){ pos++; if(pos===KONAMI.length){ pos=0; konami(); } }
    else pos = (e.keyCode===KONAMI[0]?1:0);
  });
})();
function konami(){
  const themes = ['dark','vapor','ocean'];
  const cur = localStorage.getItem(LS.theme)||'dark';
  let i = themes.indexOf(cur); i = (i+1)%themes.length;
  setTheme(themes[i]); beep();
  setTagline(i); // ruota la tagline insieme al tema
}

/* Screensaver */
let dvdAnim=null;
function toggleSaver(on){
  const ss = document.getElementById('screensaver');
  if(on){ ss.style.display='block'; startDVD(); }
  else { ss.style.display='none'; stopDVD(); }
}
function startDVD(){
  const box=document.getElementById('screensaver'), logo=document.getElementById('dvd');
  let x=100, y=100, vx=3, vy=2;
  function step(){
    const W=box.clientWidth, H=box.clientHeight, w=logo.clientWidth, h=logo.clientHeight;
    x+=vx; y+=vy;
    if(x<=0 || x+w>=W){ vx*=-1; flipLogo(); beep(); }
    if(y<=0 || y+h>=H){ vy*=-1; flipLogo(); beep(); }
    logo.style.transform=`translate(${x}px, ${y}px)`;
    dvdAnim = requestAnimationFrame(step);
  }
  step();
}
function stopDVD(){ cancelAnimationFrame(dvdAnim) }
function flipLogo(){ document.getElementById('dvd').style.filter = `hue-rotate(${Math.floor(Math.random()*360)}deg)` }

/* Finishing touches */
document.querySelectorAll('nav a').forEach(a=> a.addEventListener('click', beep));
randomCheat();
document.getElementById('themeName').textContent = localStorage.getItem(LS.theme)||'dark';
document.getElementById('themeName2').textContent = localStorage.getItem(LS.theme)||'dark';

/* =========================
   DL Screensaver & Games (modular, usa #screensaver)
   ========================= */
const DL = { anim:null, mode:null, onKey:null };

/* Canvas full-screen dentro #screensaver */
function dlOpenCanvas(){
  const ss = document.getElementById('screensaver');
  try{ stopDVD(); }catch(e){}
  ss.style.display='block';
  ss.innerHTML = '<canvas id="ssCanvas"></canvas>';
  const cv = document.getElementById('ssCanvas');
  const ctx = cv.getContext('2d');
  function resize(){ cv.width = ss.clientWidth; cv.height = ss.clientHeight; }
  resize(); addEventListener('resize', resize);
  cv._cleanupResize = ()=> removeEventListener('resize', resize);
  return { cv, ctx, ss };
}

/* Stop: chiudi tutto e ripulisci */
function stopCustomSaver(){
  try{ cancelAnimationFrame(DL.anim); }catch(e){}
  try{ removeEventListener('keydown', DL.onKey); }catch(e){}
  DL.onKey=null; DL.anim=null; DL.mode=null;
  const ss = document.getElementById('screensaver');
  if(ss){ ss.style.display='none'; ss.innerHTML='<div id="dvd">Dan Laz</div>'; }
}

/* ---------- Star Voyage ---------- */
function startStarsSaver(){
  stopCustomSaver(); DL.mode='stars';
  const {cv,ctx} = dlOpenCanvas();
  const W=()=>cv.width, H=()=>cv.height;

  const layers = [
    { count: 120, speed: 0.3, size: 1.2, color:'#9ffcff' },
    { count: 90,  speed: 0.6, size: 1.6, color:'#ff9bff' },
    { count: 60,  speed: 1.0, size: 2.0, color:'#a6ff7a' }
  ];
  const stars=[];
  layers.forEach(L=>{
    for(let i=0;i<L.count;i++){
      stars.push({
        x: Math.random()*W(), y: Math.random()*H(),
        vx:(Math.random()*2-1)*L.speed, vy:(Math.random()*2-1)*L.speed,
        r:L.size, c:L.color
      });
    }
  });

  let ship = { x: W()*0.5, y: H()*0.4, vx: 2.0, vy: 1.5 };
  function drawShip(){
    ctx.save(); ctx.translate(ship.x, ship.y);
    ctx.fillStyle = '#FFD76A';
    ctx.beginPath(); ctx.moveTo(12,0); ctx.lineTo(-8,-6); ctx.lineTo(-8,6); ctx.closePath(); ctx.fill();
    ctx.font = 'bold 20px Trebuchet MS';
    ctx.fillStyle = '#00FFFF'; ctx.shadowColor = '#FF00FF'; ctx.shadowBlur = 10;
    ctx.fillText('DAN LAZ', -60, -12);
    ctx.restore();
  }

  function step(){
    ctx.clearRect(0,0,W(),H());
    const g = ctx.createRadialGradient(W()/2,H()/2,0, W()/2,H()/2, Math.max(W(),H())*0.7);
    g.addColorStop(0,'rgba(255,255,255,0.02)'); g.addColorStop(1,'rgba(0,0,0,0.1)');
    ctx.fillStyle=g; ctx.fillRect(0,0,W(),H());

    for(const s of stars){
      s.x+=s.vx; s.y+=s.vy;
      if(s.x<0) s.x+=W(); if(s.x>W()) s.x-=W();
      if(s.y<0) s.y+=H(); if(s.y>H()) s.y-=H();
      ctx.globalAlpha=0.85; ctx.fillStyle=s.c;
      ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill();
    }
    ctx.globalAlpha=0.15; ctx.fillStyle='#00ffff';
    ctx.fillRect(ship.x-4, ship.y-2, 10, 4);
    ctx.globalAlpha=1;

    ship.x+=ship.vx; ship.y+=ship.vy;
    if(ship.x<=10 || ship.x>=W()-10){ ship.vx*=-1; beep(); }
    if(ship.y<=10 || ship.y>=H()-10){ ship.vy*=-1; beep(); }
    drawShip();

    DL.anim = requestAnimationFrame(step);
  }
  step();
}

/* ---------- Haunted House (Win98 vibes, eventi sottili) ---------- */
function startHauntedSaver(){
  stopCustomSaver(); DL.mode='haunt';
  const {cv,ctx} = dlOpenCanvas();
  const W=()=>cv.width, H=()=>cv.height;

  /* Palette */
  const PAL = {
    skyTop:'#0a1324', skyBot:'#04070d',
    moon:'#fff7cc',
    house:'#0b0c1a', roof:'#0a0f1c',
    windowOff:'#0b0c1a', windowOn:'#ffeaa9',
    porch:'#ffd76a', door:'#151c2a',
    tree:'#0a0d18', grass:'#0c121f',
    mist:'#99f0ff06', firefly:'#a6ff7a',
    bat:'#111', owl:'#221c29'
  };

  /* Layout */
  const house = {
    x: ()=> W()*0.18, y: ()=> H()*0.56,
    w: ()=> W()*0.42, h: ()=> H()*0.30
  };
  const roofHeight = ()=> H()*0.12;
  const door = {
    x: ()=> house.x()+house.w()*0.1,
    y: ()=> house.y()+house.h()*0.48,
    w: ()=> house.w()*0.16,
    h: ()=> house.h()*0.52,
    ang: 0, target: 0 // rotazione (rad)
  };
  const windows = [
    { x: ()=> house.x()+house.w()*0.30, y: ()=> house.y()+house.h()*0.20, w: ()=> house.w()*0.14, h: ()=> house.h()*0.22, lit:true,  silhouette:null },
    { x: ()=> house.x()+house.w()*0.52, y: ()=> house.y()+house.h()*0.18, w: ()=> house.w()*0.14, h: ()=> house.h()*0.22, lit:false, silhouette:null },
    { x: ()=> house.x()+house.w()*0.30, y: ()=> house.y()+house.h()*0.54, w: ()=> house.w()*0.14, h: ()=> house.h()*0.22, lit:true,  silhouette:null },
    { x: ()=> house.x()+house.w()*0.52, y: ()=> house.y()+house.h()*0.52, w: ()=> house.w()*0.14, h: ()=> house.h()*0.22, lit:false, silhouette:null },
    { round:true, cx: ()=> house.x()+house.w()*0.62, cy: ()=> house.y()-roofHeight()*0.25, r: ()=> house.w()*0.08, lit:true, silhouette:null }
  ];
  const porchLight = { on:true, flicker:0 };
  const leftTree  = { x: ()=> W()*0.08, y: ()=> H()*0.58, h: ()=> H()*0.34 };
  const rightTree = { x: ()=> W()*0.78, y: ()=> H()*0.54, h: ()=> H()*0.38 };

  const owl = { x: ()=> rightTree.x()-W()*0.02, y: ()=> rightTree.y()-rightTree.h()*0.15, state:'perch', t:0, blink:0, fly:null };
  const bats = []; // flock
  const mist = Array.from({length:28}, ()=>({ x: Math.random(), y: 0.80 + Math.random()*0.18, r: 0.012 + Math.random()*0.028, vx: (Math.random()*2-1)*0.005 }));
  const fireflies = Array.from({length:16}, ()=>({ x: Math.random(), y: 0.62 + Math.random()*0.28, phase: Math.random()*Math.PI*2 }));

  /* Audio */
  function hoot(){
    try{
      const ctxA = ac();
      const g = ctxA.createGain(); g.gain.value = 0.0001; g.connect(ctxA.destination);
      const o1 = ctxA.createOscillator(); const o2 = ctxA.createOscillator();
      o1.type='sine'; o2.type='sine';
      const t0 = ctxA.currentTime;
      o1.frequency.setValueAtTime(420, t0); o2.frequency.setValueAtTime(520, t0);
      o1.connect(g); o2.connect(g);
      g.gain.exponentialRampToValueAtTime(0.06, t0+0.08);
      g.gain.exponentialRampToValueAtTime(0.0002, t0+0.48);
      o1.start(t0); o2.start(t0); o1.stop(t0+0.50); o2.stop(t0+0.50);
    }catch(e){}
  }
  function thunder(){
    try{
      const ctxA = ac();
      const g = ctxA.createGain(); g.gain.value = 0.0001; g.connect(ctxA.destination);
      const crack = ctxA.createOscillator(); const rumble = ctxA.createOscillator();
      crack.type='square'; crack.frequency.value=2400;
      rumble.type='sawtooth'; rumble.frequency.value=90;
      crack.connect(g); rumble.connect(g);
      const t0 = ctxA.currentTime;
      g.gain.exponentialRampToValueAtTime(0.12, t0+0.02);
      g.gain.exponentialRampToValueAtTime(0.0006, t0+0.10);
      crack.start(t0); crack.stop(t0+0.10);
      g.gain.setValueAtTime(0.02, t0+0.12);
      g.gain.exponentialRampToValueAtTime(0.0002, t0+1.6);
      rumble.frequency.exponentialRampToValueAtTime(60, t0+1.2);
      rumble.start(t0+0.12); rumble.stop(t0+1.7);
    }catch(e){}
  }

  /* Eventi */
  const events = [
    { name:'windowShadow', min:6, max:16, run:spawnWindowShadow },
    { name:'doorCreak',    min:9, max:22, run:spawnDoorCreak },
    { name:'owlHoot',      min:7, max:18, run:spawnOwlHootOrFly },
    { name:'lightning',    min:20,max:40, run:spawnLightning },
    { name:'batFlock',     min:10,max:25, run:spawnBatFlock }
  ];
  let lightningFlash = { on:false, t:0, bolt:null };

  function scheduleAll(now){ events.forEach(ev=> ev.next = now + (ev.min*1000 + Math.random()*(ev.max-ev.min)*1000)); }
  function triggerRandomEvent(){ const ev = events[Math.floor(Math.random()*events.length)]; ev.run(); ev.next = performance.now() + ev.min*1000; }

  function spawnWindowShadow(){
    const choices = windows.filter(w=> !w.round && (w.lit || Math.random()<0.5));
    if(!choices.length) return;
    const w = choices[Math.floor(Math.random()*choices.length)];
    w.silhouette = { t:0, dur: 3500 + Math.random()*2000, side: Math.random()<0.5 ? -1 : 1 };
  }
  function spawnDoorCreak(){ door.target = (door.target>0 ? 0 : (Math.PI/14)); }
  function spawnOwlHootOrFly(){
    if(owl.state==='perch'){
      if(Math.random()<0.6){ owl.blink = 1.0; hoot(); }
      else{
        owl.state='fly';
        owl.fly = { x: owl.x(), y: owl.y(), vx: - (1.6 + Math.random()*0.8) * (W()/800), vy: - (0.4 + Math.random()*0.4) * (H()/600), life: 2200 };
      }
    }else{ owl.blink = 1.0; hoot(); }
  }
  function spawnLightning(){ lightningFlash.on = true; lightningFlash.t = 0; lightningFlash.bolt = genBolt(); thunder(); }
  function genBolt(){
    const path = []; let x = W()* (0.6 + Math.random()*0.3), y = H()*0.05;
    path.push([x,y]); const steps = 8 + Math.floor(Math.random()*6);
    for(let i=0;i<steps;i++){ x += (Math.random()*2-1) * W()*0.08; y += H()*0.07 + Math.random()*H()*0.05; path.push([x,y]); }
    return path;
  }
  function spawnBatFlock(){
    const dirLeft = Math.random()<0.5; const count = 3 + Math.floor(Math.random()*5);
    for(let i=0;i<count;i++){
      bats.push({ x: dirLeft ? W()+20+Math.random()*60 : -20-Math.random()*60, y: H()* (0.18 + Math.random()*0.22), vx: (dirLeft ? -1:1)*(1.2 + Math.random()*0.8), flap: Math.random()*Math.PI*2, life: 6000 + Math.random()*2000 });
    }
  }

  /* Input */
  DL.onKey = (e)=>{
    if(e.key==='Escape'){ stopCustomSaver(); return; }
    if(e.key===' '){ triggerRandomEvent(); }
  };
  addEventListener('keydown', DL.onKey);

  /* Disegno */
  function drawSky(){
    const grd = ctx.createLinearGradient(0,0,0,H()); grd.addColorStop(0, PAL.skyTop); grd.addColorStop(1, PAL.skyBot);
    ctx.fillStyle=grd; ctx.fillRect(0,0,W(),H());
    ctx.save(); ctx.translate(W()*0.82, H()*0.18);
    ctx.fillStyle=PAL.moon; ctx.beginPath(); ctx.arc(0,0, W()*0.06, 0, Math.PI*2); ctx.fill();
    ctx.globalCompositeOperation='destination-out'; ctx.beginPath(); ctx.arc(W()*0.01, -H()*0.012, W()*0.06, 0, Math.PI*2); ctx.fill();
    ctx.globalCompositeOperation='source-over'; ctx.restore();
  }
  function drawTrees(){
    ctx.fillStyle=PAL.tree;
    ctx.fillRect(leftTree.x()-W()*0.01, leftTree.y()-leftTree.h(), W()*0.02, leftTree.h());
    ctx.fillRect(rightTree.x()-W()*0.012, rightTree.y()-rightTree.h(), W()*0.024, rightTree.h());
    ctx.beginPath();
    ctx.moveTo(leftTree.x(), leftTree.y()-leftTree.h()*0.6);  ctx.lineTo(leftTree.x()-W()*0.08, leftTree.y()-leftTree.h()*0.7);
    ctx.moveTo(rightTree.x(), rightTree.y()-rightTree.h()*0.55); ctx.lineTo(rightTree.x()-W()*0.10, rightTree.y()-rightTree.h()*0.70);
    ctx.strokeStyle=PAL.tree; ctx.lineWidth=4; ctx.stroke();
  }
  function drawHouse(){
    ctx.fillStyle=PAL.grass; ctx.fillRect(0, H()*0.78, W(), H()*0.22);
    ctx.fillStyle = PAL.house; ctx.fillRect(house.x(), house.y(), house.w(), house.h());
    ctx.beginPath();
    ctx.moveTo(house.x()-10, house.y());
    ctx.lineTo(house.x()+house.w()/2, house.y()-roofHeight());
    ctx.lineTo(house.x()+house.w()+10, house.y());
    ctx.closePath(); ctx.fillStyle = PAL.roof; ctx.fill();

    // comignolo
    const cx = house.x()+house.w()*0.12, cy = house.y()-roofHeight()*0.62;
    ctx.fillStyle=PAL.roof; ctx.fillRect(cx, cy, house.w()*0.06, roofHeight()*0.30);

    // fumo morbido
    mist.forEach(p=>{
      p.x += p.vx*0.002; if(p.x<0) p.x+=1; if(p.x>1)p.x-=1;
      const x = cx + house.w()*0.02 + p.x*house.w()*0.10;
      const y = cy - roofHeight()*0.05 - (p.y*H()*0.12) - Math.sin(performance.now()*0.001 + p.x*6)*6;
      ctx.globalAlpha = 0.65; ctx.fillStyle = PAL.mist;
      ctx.beginPath(); ctx.arc(x, y, p.r*W(), 0, Math.PI*2); ctx.fill(); ctx.globalAlpha = 1.0;
    });

    // porta con rotazione intorno alla cerniera sinistra
    ctx.save();
    ctx.translate(door.x(), door.y());
    ctx.fillStyle = '#0006'; ctx.fillRect(0,0,door.w(),door.h()); // ombra fissa dietro
    ctx.save();
    ctx.translate(0,0);
    ctx.rotate(door.ang);
    ctx.fillStyle = PAL.door; ctx.fillRect(0, 0, door.w(), door.h());
    // maniglia
    ctx.fillStyle='#ffd76a'; ctx.beginPath();
    ctx.arc(door.w()*0.85, door.h()*0.55, house.w()*0.006, 0, Math.PI*2); ctx.fill();
    ctx.restore();
    ctx.restore();

    // luce portico (flicker)
    const flick = 0.7 + 0.3*Math.sin(performance.now()*0.005) + porchLight.flicker;
    ctx.globalAlpha = Math.max(0, Math.min(1, 0.5+flick*0.4));
    ctx.fillStyle = PAL.porch;
    ctx.beginPath(); ctx.arc(door.x()+door.w()*0.5, door.y()-house.h()*0.06, house.w()*0.02, 0, Math.PI*2); ctx.fill();
    ctx.globalAlpha = 1.0;

    // finestre
    windows.forEach(w=>{
      if(w.round) return;
      const glow = w.lit ? PAL.windowOn : PAL.windowOff;
      ctx.fillStyle = glow; ctx.fillRect(w.x(), w.y(), w.w(), w.h());
      ctx.strokeStyle = '#0005'; ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(w.x()+w.w()/2, w.y()); ctx.lineTo(w.x()+w.w()/2, w.y()+w.h());
      ctx.moveTo(w.x(), w.y()+w.h()/2); ctx.lineTo(w.x()+w.w(), w.y()+w.h()/2);
      ctx.stroke();

      if(w.silhouette){
        const prog = Math.min(1, w.silhouette.t / w.silhouette.dur);
        const sx = w.x() + (w.silhouette.side<0 ? w.w()*(0.05 + 0.9*prog) : w.w()*(0.95 - 0.9*prog));
        const sy = w.y() + w.h()*0.65;
        ctx.save(); ctx.globalAlpha = 0.8; ctx.fillStyle = '#0a0a18';
        ctx.beginPath();
        ctx.arc(sx, sy-w.h()*0.20, w.w()*0.14, Math.PI, 0);
        ctx.quadraticCurveTo(sx+w.w()*0.14, sy-w.h()*0.02, sx, sy+w.h()*0.06);
        ctx.quadraticCurveTo(sx-w.w()*0.14, sy-w.h()*0.02, sx-w.w()*0.14, sy-w.h()*0.20);
        ctx.closePath(); ctx.fill(); ctx.restore();
      }
    });

    // abbaino rotondo (attico)
    const att = windows.find(w=>w.round);
    if(att){
      ctx.fillStyle = att.lit ? PAL.windowOn : PAL.windowOff;
      ctx.beginPath(); ctx.arc(att.cx(), att.cy(), att.r(), 0, Math.PI*2); ctx.fill();
      if(att.silhouette){
        ctx.save(); ctx.globalAlpha=0.85; ctx.fillStyle='#0a0a18';
        const prog = Math.min(1, att.silhouette.t / att.silhouette.dur);
        const x = att.cx(), y = att.cy();
        ctx.beginPath();
        ctx.arc(x-att.r()*0.35, y, att.r()*0.12*(0.8+0.2*Math.sin(prog*Math.PI*2)), 0, Math.PI*2);
        ctx.arc(x+att.r()*0.35, y, att.r()*0.12*(0.8+0.2*Math.sin(prog*Math.PI*2)), 0, Math.PI*2);
        ctx.fill(); ctx.restore();
      }
    }
  }
  function drawOwl(){
    const ox = owl.state==='fly' ? owl.fly.x : owl.x();
    const oy = owl.state==='fly' ? owl.fly.y : owl.y();
    ctx.fillStyle = PAL.owl;
    ctx.beginPath(); ctx.ellipse(ox, oy, W()*0.015, H()*0.025, 0, 0, Math.PI*2); ctx.fill();
    const blink = Math.max(0, owl.blink);
    const eyeR = W()*0.004 * (blink>0 ? 0.2 : 1.0);
    ctx.fillStyle = '#ffd76a';
    ctx.beginPath(); ctx.arc(ox-W()*0.006, oy-H()*0.006, eyeR, 0, Math.PI*2); ctx.arc(ox+W()*0.006, oy-H()*0.006, eyeR, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = '#33220a';
    ctx.beginPath(); ctx.moveTo(ox, oy-H()*0.002); ctx.lineTo(ox+W()*0.004, oy+H()*0.003); ctx.lineTo(ox-W()*0.004, oy+H()*0.003); ctx.closePath(); ctx.fill();
  }
  function drawBats(){
    bats.forEach(b=>{
      b.x += b.vx; b.flap += 0.25; b.life -= 16; if(b.life<=0) return;
      ctx.save(); ctx.translate(b.x, b.y);
      const wing = 14 + Math.sin(b.flap)*6;
      ctx.fillStyle = PAL.bat;
      ctx.beginPath();
      ctx.moveTo(0,0);
      ctx.quadraticCurveTo(-wing,-8, -18,0);
      ctx.lineTo(0,0);
      ctx.quadraticCurveTo(wing,-8, 18,0);
      ctx.closePath(); ctx.fill();
      ctx.restore();
    });
    for(let i=bats.length-1;i>=0;i--) if(bats[i].life<=0 || bats[i].x<-40 || bats[i].x>W()+40) bats.splice(i,1);
  }
  function drawFireflies(){
    fireflies.forEach(f=>{
      f.phase += 0.05 + Math.random()*0.02;
      const a = 0.3 + 0.7*(0.5+0.5*Math.sin(f.phase));
      ctx.globalAlpha = a; ctx.fillStyle = PAL.firefly;
      ctx.beginPath(); ctx.arc(f.x*W(), f.y*H(), W()*0.003, 0, Math.PI*2); ctx.fill();
      ctx.globalAlpha = 1.0;
    });
  }
  function drawLightning(){
    if(!lightningFlash.on || !lightningFlash.bolt) return;
    const t = lightningFlash.t;
    const glow = Math.max(0, 1.0 - t*1.8);
    ctx.save(); ctx.globalAlpha = glow*0.6; ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,W(),H()); ctx.restore();
    ctx.save();
    ctx.strokeStyle = '#e6f2ff'; ctx.lineWidth = 3 + 4*Math.max(0, 0.9 - t);
    ctx.shadowColor = '#cfe8ff'; ctx.shadowBlur = 16;
    ctx.beginPath(); const bolt = lightningFlash.bolt;
    ctx.moveTo(bolt[0][0], bolt[0][1]); for(let i=1;i<bolt.length;i++) ctx.lineTo(bolt[i][0], bolt[i][1]); ctx.stroke();
    ctx.restore();
  }

  /* Loop */
  let last = performance.now(); scheduleAll(last);
  function step(now){
    const dt = now - last; last = now;

    // Porta verso target
    door.ang += (door.target - door.ang) * 0.08;

    // Silhouette finestre
    windows.forEach(w=>{
      if(w.silhouette){ w.silhouette.t += dt; if(w.silhouette.t >= w.silhouette.dur){ w.silhouette = null; } }
    });
    const att = windows.find(w=>w.round);
    if(att && att.silhouette){ att.silhouette.t += dt; if(att.silhouette.t >= att.silhouette.dur) att.silhouette=null; }

    // Gufo
    if(owl.blink>0) owl.blink = Math.max(0, owl.blink - dt*0.002);
    if(owl.state==='fly' && owl.fly){
      owl.fly.x += owl.fly.vx; owl.fly.y += owl.fly.vy; owl.fly.life -= dt;
      if(owl.fly.life<=0 || owl.fly.y < H()*0.05 || owl.fly.x < -40){ owl.state='perch'; owl.fly=null; }
    }

    // Fulmine decay
    if(lightningFlash.on){ lightningFlash.t += dt/600; if(lightningFlash.t>=1.0){ lightningFlash.on=false; lightningFlash.t=0; lightningFlash.bolt=null; } }

    // Porch flicker casuale
    porchLight.flicker = (Math.random()*2-1) * 0.15;

    // Scheduler
    events.forEach(ev=>{ if(now >= ev.next){ ev.run(); ev.next = now + (ev.min*1000 + Math.random()*(ev.max-ev.min)*1000); } });

    // Draw
    ctx.clearRect(0,0,W(),H());
    drawSky(); drawTrees(); drawHouse(); drawOwl(); drawBats(); drawFireflies(); drawLightning();

    DL.anim = requestAnimationFrame(step);
  }
  step(last);
}

/* ---------- Maze Runner (gioco) ---------- */
function startMazeGame(){
  stopCustomSaver(); DL.mode='maze';
  const {cv,ctx} = dlOpenCanvas();
  const W=()=>cv.width, H=()=>cv.height;

  const cols = 17, rows = 13, cell = Math.floor(Math.min(W()/cols, H()/rows));
  const ox = Math.floor((W() - cols*cell)/2), oy = Math.floor((H() - rows*cell)/2);

  const grid = Array.from({length:rows}, ()=> Array.from({length:cols}, ()=>({v:false, walls:[1,1,1,1]})));
  const dir = [[0,-1],[1,0],[0,1],[-1,0]];
  function carve(cx,cy){
    grid[cy][cx].v=true;
    const order=[0,1,2,3].sort(()=>Math.random()-0.5);
    for(const d of order){
      const nx=cx+dir[d][0], ny=cy+dir[d][1];
      if(nx<0||ny<0||nx>=cols||ny>=rows) continue;
      if(!grid[ny][nx].v){
        grid[cy][cx].walls[d]=0; grid[ny][nx].walls[(d+2)%4]=0;
        carve(nx,ny);
      }
    }
  }
  carve(0,0);

  const player = { x:0, y:0 };
  const exit = { x:cols-1, y:rows-1 };
  const scary = new Set(), fun = new Set();
  for(let i=0;i<10;i++){ scary.add((Math.floor(Math.random()*rows)<<8) + Math.floor(Math.random()*cols)); }
  for(let i=0;i<8;i++){ fun.add((Math.floor(Math.random()*rows)<<8) + Math.floor(Math.random()*cols)); }

  DL.onKey = (e)=>{
    let nx=player.x, ny=player.y;
    if(e.key==='ArrowUp'   && grid[ny][nx].walls[0]===0) ny--;
    if(e.key==='ArrowRight'&& grid[ny][nx].walls[1]===0) nx++;
    if(e.key==='ArrowDown' && grid[ny][nx].walls[2]===0) ny++;
    if(e.key==='ArrowLeft' && grid[ny][nx].walls[3]===0) nx--;
    if(nx!==player.x || ny!==player.y){ player.x=nx; player.y=ny; beep(); }
    if(player.x===exit.x && player.y===exit.y){
      ctx.save(); ctx.fillStyle='rgba(0,255,170,0.2)'; ctx.fillRect(0,0,W(),H()); ctx.restore();
      setTimeout(()=> stopCustomSaver(), 700);
    }
  };
  addEventListener('keydown', DL.onKey);

  function drawCell(cx,cy){
    const x = ox + cx*cell, y = oy + cy*cell;
    ctx.strokeStyle='#00FFFF'; ctx.lineWidth=2;
    if(grid[cy][cx].walls[0]){ ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x+cell,y); ctx.stroke(); }
    if(grid[cy][cx].walls[1]){ ctx.beginPath(); ctx.moveTo(x+cell,y); ctx.lineTo(x+cell,y+cell); ctx.stroke(); }
    if(grid[cy][cx].walls[2]){ ctx.beginPath(); ctx.moveTo(x+cell,y+cell); ctx.lineTo(x,y+cell); ctx.stroke(); }
    if(grid[cy][cx].walls[3]){ ctx.beginPath(); ctx.moveTo(x,y+cell); ctx.lineTo(x,y); ctx.stroke(); }
    const key = (cy<<8)+cx;
    if(scary.has(key)){
      ctx.fillStyle='#ff0044';
      ctx.beginPath(); ctx.arc(x+cell*0.35,y+cell*0.5, 3,0,Math.PI*2); ctx.arc(x+cell*0.65,y+cell*0.5,3,0,Math.PI*2); ctx.fill();
    }
    if(fun.has(key)){
      ctx.fillStyle='#ffd76a';
      ctx.beginPath(); ctx.rect(x+cell*0.4,y+cell*0.4, cell*0.2, cell*0.2); ctx.fill();
    }
  }

  function step(){
    ctx.clearRect(0,0,W(),H());
    ctx.font='bold 24px Trebuchet MS'; ctx.fillStyle='#FF00FF'; ctx.shadowColor='#00FFFF'; ctx.shadowBlur=10;
    ctx.fillText('MAZE RUNNER ‚Äî DAN LAZ', ox, oy-16);

    for(let y=0;y<rows;y++) for(let x=0;x<cols;x++) drawCell(x,y);

    const px = ox + player.x*cell + cell/2, py = oy + player.y*cell + cell/2;
    ctx.fillStyle='#00ff99'; ctx.beginPath(); ctx.arc(px,py, cell*0.28,0,Math.PI*2); ctx.fill();

    const ex = ox + exit.x*cell + cell/2, ey = oy + exit.y*cell + cell/2;
    ctx.strokeStyle='#ffd76a'; ctx.lineWidth=3; ctx.beginPath(); ctx.arc(ex,ey, cell*0.32,0,Math.PI*2); ctx.stroke();

    DL.anim = requestAnimationFrame(step);
  }
  step();
}

/* ---------- Tagline cycler (opzionale) ---------- */
const TAGLINES = [
  ["Welcome to the greatest website on Earth", "‚Äî Dan Laz"],
  ["You just entered the best site ever", "‚Äî Dan Laz"],
  ["World‚Äôs finest website. Powered by", "Dan Laz"]
];
function setTagline(i=0){
  const t = TAGLINES[i % TAGLINES.length];
  const intro = document.querySelector('#psxIntro .introTagline');
  const header = document.querySelector('.subtitle.mono');
  if(intro){
    const t1 = intro.querySelector('.t1'), t2 = intro.querySelector('.t2');
    if(t1) t1.textContent = t[0];
    if(t2) t2.textContent = t[1].startsWith('‚Äî') ? t[1] : `‚Äî ${t[1]}`;
  }
  if(header){
    header.textContent = `${t[0]} ‚Äî ${t[1].replace(/^‚Äî\\s*/,'')} ‚Ä¢ Best viewed in 800√ó600`;
  }
}
window.setTagline = setTagline;
</script>
</body>
</html>
